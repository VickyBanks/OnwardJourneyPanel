---
title: "TV Onward Navigation Bar Journeys"
author: "VickyBanks"
date: "03/02/2020"
output:
  html_document:
    toc_float: true
    toc: true
    theme: cerulean
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(error = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(fig.align="center")
library(tidyverse)
library(DBI)
library(dbplyr)
library("RSQLite")
library(knitr)
library(gridExtra)
library(grid)
library(ggplot2)
library(reshape2)
library(lubridate)
library(readr)
library(kableExtra)
library(scales)
library(RColorBrewer)
library(wesanderson)

library(ggplot2)
library(ggridges)
library(dplyr)
library(ggrepel)
#For the sankey diagram
library(tidyverse)
library(plotly)
library(tidygraph)
library(igraph)
library(htmlwidgets)
library(networkD3)
options(scipen = 999) # so that numbers don't display with the exponent
options(dplyr.width = Inf) # to print all selected variables
theme_set(theme_classic()) # sets the ggplot theme for the session
theme_update(plot.caption = element_text(size=6))
```

# Overview
The project was looking at the onward naviagtion bar on iPlayer big screen that users access during playback of content. The menu consists of two parts: related content from the same brand or recomendations of programs regarded as similar to this brand. 

The time period analysed was 2020-01-15 to 2020-01-29 and all visits to big screen where the navigation bar was click were included. During this time there were 4,065,977 (~8.5%) visits containing at least one click and 43,824,893 (~91.5%) without a click. The click was identified by the labels 'page-section-related~select' and 'page-section-rec~select' in the attribute field of the s3_audience.publosher table in SCV. Of all clicks identified 15% were to the recommended section and 85% to the related section.


# Click Destination

The hypothesis suggested that users were clicking the navigation bar as a shortcut to find their desired content so the content their click took them to was compared to the initial content. Content was split into several categories: content of a different brand entirely, content of the same brand and same series, within this if it was the next episode or not, and content of the same brand but another series again within this splitting into if content was the next episode (i.e first of a new series) or not.

To do this, each record had the brand and series IDs associated with the content ID determined using the prez.scv_vmb table and the numerical position of the episode within a series identified using the central_insights_sandbox.episode_numbers table. Content was then grouped by brand and ordered by series to number all episodes in sequence to allow the journey from the final episode of one series to the first of the next to be identified as the 'next episode'. Multiple verison of series such as the standard content comapred to a 30 minute cutdown were defined as distict from one another. 

```{r clickDestinationSankey, echo = FALSE}
nextEpInfo <- read.csv("next_ep_type_Jan2020.csv", header = TRUE)
nextEpInfo <- nextEpInfo %>% rename(clickTime_sec = time_since_content_start_sec)
nextEpInfo <- nextEpInfo %>% rename(menuType = menu_type)
nextEpInfo <- nextEpInfo %>% rename(uv = unique_visitor_cookie_id)
nextEpInfo <- na.omit(nextEpInfo)
nextEpInfo$visit_id <-as.character(nextEpInfo$visit_id)

#Create Sankey Diagram
nodes = data.frame("name" = factor(c("All Clicks",
                                     "Diff Brand - 9%",
                                     "Same Brand - 91%",
                                     "Same Series - 74%",
                                     "Diff Series - 16%",
                                     "Next Ep - 23%",
                                     "Other Ep - 51%",
                                     "Next Ep - 0.3%",
                                     "Other Ep - 16%")),
                   "group" = as.character(c(1, 2, 2, 3, 3, 4, 4, 5, 5)))

links <- as.data.frame(matrix(byrow = T, ncol = 3, 
                              c(0, 1, 619855,
                                0, 2, 5920193,
                                2, 3, 4841409,
                                2, 4, 1078784,
                                3, 5, 1509540,
                                3, 6, 3331869,
                                4, 7, 22430,
                                4, 8, 1056354)))
names(links) <- c("source","target","value")

#Colour to match bar charts
nodes$group<-as.factor(c("a","b","c","d","e","f","g","h","i"))
colours <- 'd3.scaleOrdinal() .domain(["a","b","c","d","e","f","g","h","i"]) 
.range(["#043570", "#F21A00" , "#C0C0C0", "#5AA9BC", "#E6BE15","#3B9AB2", "#78B7C5","#EBCC2A", "#E1AF00"])'


allClicksSankey <- sankeyNetwork(Links = links, Nodes = nodes, Source = "source", 
              Target = "target", Value = "value", NodeID = "name", 
              NodeGroup = "group", colourScale = colours, fontSize = 12)


htmlwidgets::onRender(allClicksSankey, jsCode =
        'function(){
          document.getElementsByTagName("svg")[0].setAttribute("viewBox", "");
          document.getElementsByTagName("svg")[1].setAttribute("viewBox", "");
          document.getElementsByTagName("svg")[2].setAttribute("viewBox", "");
          document.getElementsByTagName("svg")[3].setAttribute("viewBox", "");
          document.getElementsByTagName("svg")[4].setAttribute("viewBox", "");
        }')

```

From this it can be seen that 91% of journeys continued onto another episode in the same brand, 23% of those to the next episode, 51% to another episode in the series and 16% moved to another series where the new content was not the user's next episode. This very much indicated that users are using this menu to move between episodes of a single brand, with very few users using this as a place for descovering new content.



# Time To Click
To determine the time user's took to click content, each action in their visit was collected from the s3_audience.publosher table in SCV. The episode ID of the content being viewed when the user clicked was found and the beginning of their viewing identified as the first time that episode ID appeared. This was identified such that if a user viewed a piece of content, then left the content and then returned, the start time would be the return time, not the initial view. The time between the start of content viewing and clicking the navigation bar was calculated in seconds. 

```{r timeToClick, echo = FALSE}
clickTime<- read.csv("time_to_click_Jan2020.csv", header = TRUE)
clickTime <- clickTime %>% rename(clickTime_sec = time_since_content_start_sec)
clickTime <- clickTime %>% rename(menuType = menu_type)
clickTime<- na.omit(clickTime)
clickTimeMinutes <- clickTime %>% 
    mutate(timeRange_sec = cut(clickTime_sec, 
                               breaks = c(-1, 60,120,180,240, 300,360,420,480,540, 600,Inf),
                               labels = c("0-1", "1-2", "2-3", "3-4", "4-5", "5-6", "6-7", "7-8", "8-9", "9-10", "10+")))

kable(clickTimeMinutes[9:14,], row.names = FALSE, col.names = c("Menu Section", "Visit ID", "Time to Click (sec)", "Minute Band") ) %>% kable_styling(bootstrap_options = c("striped", "hover"), full_width = F) 

clickTimeMinutes<- clickTimeMinutes %>% group_by(timeRange_sec) %>% 
    summarize(numInRange=n()) %>%
    mutate(perc = round(100*numInRange/sum(numInRange),1))
```

The number of clicks faling within each minute was counted and is displayed below.


```{r timeToClickGraph, echo = FALSE}
  ggplot(data = clickTimeMinutes, aes(x=timeRange_sec, y=numInRange))+
    geom_bar(stat = "identity", fill = "#043570") +
    scale_y_continuous(limits = c(0,5000000), breaks = c(0,250000, 1000000,2000000,3000000,4000000,5000000), labels = c(0,0.25, 1,2,3,4,5))+
    ylab("Number of Visits with Click in Time Range (millions)")+
    xlab("Time Range (mins)")+
    geom_hline(yintercept = 250000)+
    geom_label(data=subset(clickTimeMinutes, perc > 7),
              aes(label=paste0(sprintf("%1.0f", perc),"%"),),
              position = position_stack(vjust = 0.5),
              colour="black")+
    geom_label(data=subset(clickTimeMinutes, perc >= 6 & perc < 7),
               aes(label=paste0(sprintf("%1.0f", perc),"%"),),
               position = position_stack(vjust = 1.6),
               colour="black")+
    ggtitle("Number of Clicks to the Onward Journey Panel 'x' Minutes After Content Start \n PS_IPLAYER - Big Screen - 2019-11-01 to 2019-11-14" )+
  theme_classic()



```




Part of the hypothesis suggested that users were specifically selecting content in order to use this navigation bar to move to other episodes. If this were correct then most clicks would occur within the first minute or two of content being viewed when users were moving to the same brand, rather than at the end of viewing that content. Similarly, this pattern should be less evident for users moving to a new brand as they would not be able to predict which brands the recomendation section would show.




```{r timeToClickGraphDestination, echo = FALSE, fig.height = 10, fig.width = 10}

nextEpInfoDest <- nextEpInfo %>% mutate(nextEpClass = paste(same_brand,same_brand_series,next_ep))


#turn binary into labels
nextEpClass <- data.frame("nextEpClass" = c("1 1 1","1 1 0","1 0 1","1 0 0","0 0 0"),
               "clickDestination" = c("Same Brand & Series, Next Ep",
                                      "Same Brand & Series, Diff Ep", 
                                      "Same Brand, Diff Series, Next Ep",
                                      "Same Brand, Diff Series, Diff Ep",
                                      "New Brand"))

nextEpInfoDest<- left_join(nextEpInfoDest, nextEpClass, by = "nextEpClass")
nextEpInfoDest$nextEpClass <- factor(nextEpInfoDest$nextEpClass, levels=c("1 1 1","1 1 0","1 0 1","1 0 0","0 0 0"))
nextEpInfoDest$clickDestination <- factor(nextEpInfoDest$clickDestination, levels=c("Same Brand & Series, Next Ep", "Same Brand & Series, Diff Ep", "Same Brand, Diff Series, Next Ep","Same Brand, Diff Series, Diff Ep","New Brand"))

#split into minutes
nextEpInfoMins<- nextEpInfoDest %>% 
  mutate(timeRange_sec = cut(clickTime_sec, 
                             breaks = c(-1, 60,120,180,240, 300,360,420,480,540, 600,Inf),
                             labels = c("0-1", "1-2", "2-3", "3-4", "4-5", "5-6", "6-7", "7-8", "8-9", "9-10", "10+"))) %>% 
  group_by(nextEpClass,clickDestination, timeRange_sec) %>% 
  summarize(numInRange=n()) %>%
  mutate(perc = round(100*numInRange/sum(numInRange),1)) 




ggplot(data = nextEpInfoMins, aes(x=timeRange_sec, y=numInRange/1000000, fill = clickDestination))+
  geom_bar(stat = "identity")+
  #scale_y_continuous(limits = c(0,5000000), breaks = c(0,250000, 1000000,2000000,3000000,4000000,5000000), labels = c(0,0.25, 1,2,3,4,5))+
  ylab("Number of Visits with Click in Time Range (millions)")+
  xlab("Time Range (mins)")+
  geom_label(data=subset(nextEpInfoMins, perc >= 9),
             aes(label=paste0(sprintf("%1.0f", perc),"%"),),
             position = position_stack(vjust = 0.5),
             colour="black", 
             fill = "white")+
  ggtitle("Number of Clicks to the Onward Journey Panel 'x' Minutes After Content Start \n PS_IPLAYER - Big Screen - 2019-11-01 to 2019-11-14" )+
  scale_fill_manual(name = "Click Destination", values=wes_palette(n=5, name="Zissou1"))+
  theme_classic() +
  facet_wrap(~ clickDestination, ncol = 2, nrow = 3, scales = "free") +
 theme(legend.position = "none") 


```


# Click Origin


```{r contentOriginsData, echo=FALSE}
allClickOrigins<- read.csv("allContentClickOrigins.csv", header = TRUE)
allClickOrigins$placement<- recode(allClickOrigins$placement, 
                                                 'categories_page_kids' = 'categories',
                                                 'categories_page_not_kids' = 'categories',
                                                 'tleo_page' = 'tleo',
                                                 'channel_page' = 'channels',
                                                 'search_page' = 'search',
                                                 'other_page' = 'other',
                                                 'episode_page' = 'episode')

allClickOrigins$placement<- factor(allClickOrigins$placement,
                                   levels =c('homepage', 'tleo', 'episode', 'channels', 'categories', 'deeplink', 'search', 'other') )

# Read in click origins for content where the nav was then clicked and set names
navClickOrigins<- read.csv("navContentClickOrigins.csv", header = TRUE)
navClickOrigins$content_click_placement<- recode(navClickOrigins$content_click_placement, 
                                                 'categories_page_kids' = 'categories',
                                                 'categories_page_not_kids' = 'categories',
                                                 'tleo_page' = 'tleo',
                                                 'channel_page' = 'channels',
                                                 'search_page' = 'search',
                                                 'other_page' = 'other',
                                                 'episode_page' = 'episode')

navClickOrigins$content_click_placement<- factor(navClickOrigins$content_click_placement, 
                                                 levels =c('homepage', 'tleo', 'episode', 'channels', 'categories', 'deeplink', 'search', 'other') )


#nextEpInfo <- nextEpInfo %>% rename(clickTime_sec = time_since_content_start_sec)

###### How does the route to content differ for those where the nav was clicked?
navClickPlacement <- navClickOrigins %>% 
  group_by(content_click_placement) %>%
  summarise(numEvents = n()) %>%
  arrange(desc(numEvents)) %>%
  mutate(perc = round(100*numEvents/sum(numEvents),1))
navClickPlacement$placement<- navClickPlacement$content_click_placement 
navClickPlacement <- navClickPlacement %>% select(placement, numEvents,perc)

allClickPlacement <- allClickOrigins %>% 
  group_by(placement) %>%
  summarise(numEvents = sum(num_content_clicks)) %>%
  arrange(desc(numEvents)) %>%
  mutate(perc = round(100*numEvents/sum(numEvents),1))

clickPlacementComparison <- bind_rows(
  allClickPlacement %>% mutate(clickGroup = 'allContent'),
  navClickPlacement %>% mutate(clickGroup = 'navClick'))


```


For each piece of content being viewed when the onward journey navigation was clicked, the origin of the content was found. This was the page where the click to reach content occurred, for example the homepage, a channel page or a TLEO page. Content currently being viewed could also be the origin for another piece of content; in these examples the content origin was classified as as 'episode' page. Deep links into product were also a source. It is worth noting that homepage clicks are only those that take users directly into content, such as the continue watching rail, many click on the homepage would take users to a TLEO from which they select content. 


```{r contentOriginsGraph, echo=FALSE, fig.height = 7, fig.width = 10}
## Plot data
ggplot(clickPlacementComparison, aes(x = clickGroup, y = perc, fill = clickGroup)) +
  geom_bar(stat = "Identity", position = position_dodge(width = 1) )+
  scale_y_continuous(limits = c(0,50), breaks = c(0,5,10,15,20,25,30,35,40,45,50), 
                     labels = c(0,5,10,15,20,25,30,35,40,45,50))+
  scale_fill_manual(values = c("#037301","#043570"), name = "Click Group", labels = c("All Content", "Nav Click Content"))+
  ylab("Percentage of Content CLicks from Each Origin")+
  xlab("Content Origin Page")+
  ggtitle("Routes to Content Comparison \n PS_IPLAYER - Big Screen - 2020-01-15 to 2020-01-29")+
  #scale_fill_discrete(name = "Click Group", labels = c("All Content", "Nav Click Content"))+
  #geom_hline(yintercept = 5, linetype = "dashed")+
  geom_text(data=subset(clickPlacementComparison, perc > 1),
             aes(label=paste0(sprintf("%1.0f", perc),"%"),),
             position = position_dodge(width = 1),
             vjust = -0.5,
             colour="black")+
  facet_wrap(~ placement, nrow = 1, strip.position = "bottom")+
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
```

## Content Origin Identification
Users complete many clicks to content within their visits so in order to identify the content click that took users to the content being viewed when the navigation bar was clicked three levels of check were completed. Firstly the ID of the content click was matched with the ID of the content being viewed. Secondly,if the ID check was not possible, the master brand of the content click was matched with the masterbrand of the content being viewed. Finally, if the first two were not possible, the content click directly before the navigation click was used. The table below shows the propotion clicks from each origin validated with each type of check.

```{r checkTypeTable, echo = FALSE}

# Find the percentage of clicks with each check for each origin
#colour the max for each as blue
navClickOrigins %>%group_by(content_click_placement,check_type)%>%
  summarise(numClicks = n()) %>%
  mutate(perc = round(100*numClicks/sum(numClicks),1))%>%
  select(-numClicks)%>%
  spread(key = check_type, value = perc) %>%
  mutate_all(~replace(., is.na(.), 0)) %>%
  mutate(ep_id_check = cell_spec(ep_id_check, "html",
                                 bold = if_else(ep_id_check > 90, T,F), 
                                 color = if_else(ep_id_check > 90, "#043570","black")),
         master_brand_check = cell_spec(master_brand_check, "html",
                                        bold = if_else(master_brand_check > 90, T,F),
                                        color = if_else(master_brand_check> 90, "#043570","black")),
         only_position_check = cell_spec(only_position_check, "html",
                                         bold = if_else(only_position_check > 90, T,F),
                                         color = if_else(only_position_check > 90, "#043570","black"))
         ) %>%
    kable(format = "html", escape = F,
          row.names = FALSE, 
      col.names = c("Page", "Episode ID", "Masterbrand", "Position Check")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F) %>%
  add_header_above(header = c(" " = 1, "Percentage of Clicks per Check Type" = 3))

```


```{r contentPercentages, echo = FALSE}
# kable(clickPlacementComparison %>% 
#         select(-numEvents) %>%
#         spread(key = clickGroup, value = perc)%>%
#         arrange(desc(allContent)), 
#       row.names = FALSE, 
#       col.names = c("Content Origin", "Percentage of \n All Content Origins","Percentage of \n Nav Click Content Origins")) %>% 
#   kable_styling(bootstrap_options = c("striped", "hover"), full_width = F) 

```

## Homepage

Users clicking the onward navigation bar are more likely to have arrived at the content from the homepage than users not using the navigation bar. The most likely route to content is through the 'continue watching' module followed by the 'editorial featured' module, but for those using the navigation bar the proportion coming form 'continue watching' is far higher. This supports the hypothesis that users are selecting content in the continue watching bar with the intention to immediately use the navigation to find the right content episode. 


```{r homepageClickBreakdown, echo = FALSE}
homepageAllClicks<- allClickOrigins %>% filter(placement == 'homepage' & 
                                                 !str_detect(simple_container_name, "u16|u13")) %>%
  group_by(placement, simple_container_name) %>%
  summarise(numClicks = sum(num_content_clicks)) %>%
  mutate(perc = round(100*numClicks/sum(numClicks),2), clickGroup = "allClicks") %>%
  arrange(desc(perc))%>%
  rename(container = simple_container_name)

homepageNavClicks<- navClickOrigins %>% filter(content_click_placement == 'homepage' & 
                                                 !str_detect(content_click_container, "u16|u13")) %>%
  group_by(content_click_placement, content_click_container) %>%
  summarise(numClicks = n()) %>%
  mutate(perc = round(100*numClicks/sum(numClicks),2), clickGroup = "navClicks") %>%
  arrange(desc(perc))%>% 
  rename(container = content_click_container, placement = content_click_placement)


fancyContainerName<- read.csv("fancyContainerName.csv", header = TRUE)
homepageComparison<- bind_rows(homepageNavClicks, homepageAllClicks)
homepageTable <- left_join(homepageComparison %>% 
                             filter(clickGroup == "navClicks")%>% 
                             top_n(n=10,wt = perc) %>% 
                             select(container),
                           homepageComparison %>% 
                             select(-numClicks, -placement)) %>% 
  spread(key = clickGroup, value = perc) %>%
  arrange(desc(allClicks))
homepageTable <- left_join(homepageTable, fancyContainerName, by = "container") %>% 
  select(placement,fancy_container_name,allClicks,navClicks)

kable(homepageTable, 
      row.names = FALSE, 
      col.names = c("Page", "Module", "All Content", "Nav Click Content")) %>% 
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F) %>%
add_header_above(header = c(" " = 2, "Percentage of clicks" = 2))
```



## Episode Pages
In most cases (89%) the autoplay system takes users from one episode to another, however in cases where users click the onward navigation bar on the second episode page they are far less likely to have come through autoplay (35% of cases). Instead, 65% of journeys came from the user purposefully selecting the onward journey navigation bar which is significantly higher than the 14% for journeys where the navigation is not selected on the second episode. So users leaving a piece of content via navigation bar are far more likely to arrive by the navigation bar suggesting that viewers are potentially navigating through multiple pages to reach the desired content.



```{r episodeOriginsGraph, echo = FALSE, fig.width = 10}
### How are users from an episode page getting to the next content
#Join the all clicks content and the anv clicks content origin summaires
episodeOrigins<- left_join(
navClickOrigins %>% filter(content_click_placement== 'episode') %>%
  group_by(content_click_container) %>%
  summarise(numEvents = n()) %>%
  mutate(navPerc = round(numEvents/sum(numEvents),3))%>% 
  select(-numEvents),
allClickOrigins %>% filter(placement == 'episode') %>%
  group_by(simple_container_name) %>%
  summarise(numEvents = sum(num_content_clicks)) %>%
  mutate(allPerc = round(numEvents/sum(numEvents),3))%>%
  select(-numEvents), by= c("content_click_container"="simple_container_name"))

#Set lebels and simplify names
episodeOrigins<- episodeOrigins%>%rename(container = content_click_container)
episodeOrigins<- gather(data= episodeOrigins, key = "clickGroup", value = "perc", navPerc, allPerc)
episodeOrigins$container<- recode(episodeOrigins$container, 
                                  "page-section-rec" = 'Nav Click - Rec',
                                    "onward-journey-autoplay-next-rec" = 'Autoplay - Rec',
                                    "page-section-related" = 'Nav Click - Related',
                                    "onward-journey-autoplay-next-episode" = 'Autoplay - Related')
episodeOrigins$container<-factor(episodeOrigins$container, 
                                 levels = c( "Autoplay - Related",
                                            "Autoplay - Rec",
                                            "Nav Click - Related",
                                            "Nav Click - Rec"))

#Bar Chart of how people go from one episode to another
ggplot(episodeOrigins, aes(x = clickGroup, y = perc, fill = clickGroup)) +
  geom_bar(stat = "Identity", position = position_dodge(width = 1) )+
  scale_y_continuous(limits = c(0,0.80), breaks = c(0,0.05,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8), 
                     labels = c(0,5,10,20,30,40,50,60,70,80))+
  scale_fill_manual(values = c("#037301","#043570"), name = "Click Group", labels = c("All Content", "Nav Click Content"))+
  ylab("Percentage of Content Clicks from Each Origin")+
  xlab("Route From One Episode to the Next")+
  ggtitle("Routes From One Episode to Another \n PS_IPLAYER - Big Screen - 2020-01-15 to 2020-01-29")+
  #scale_fill_discrete(name = "Click Group", labels = c("All Content", "Nav Click Content"))+
  geom_hline(yintercept = 0.05, linetype = "dashed")+
  geom_text(data=subset(episodeOrigins, perc > 0.05),
            aes(label=paste0(sprintf("%1.0f", 100*perc),"%"),),
            position = position_dodge(width = 1),
            vjust = -0.5,
            colour="black")+
  facet_wrap(~ container, nrow = 1, strip.position = "bottom")+
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
```

Of those people who leave content via the navigation bar, 50% + 15% arrived using the navigation bar. Normally only 10+4% use that to get from one episode to another. 
If they use the nav bar to get to content, they're very likely to use it again. 
So if they use it, they're big users.

Maybe for this graph we only need the % of those using the nav bar. 


# Full Journeys

